<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Middle Ages - region</title>
<!--library: three.js-->
<script src="library/three.js"></script>
<!--camera controls-->
<script src="controls/FPControls.js"></script>
<!--climate and regions-->
<script src="openregions.js"></script>
<!--towns-->
<script src="buildings/maker_towns.js"></script>
<script src="buildings/maker_center.js"></script>
<script src="buildings/maker_capital.js"></script>
<script src="buildings/maker_castletown.js"></script>
<script src="buildings/maker_abbeytown.js"></script>
<!--buildings and plots-->
<script src="buildings/maker_farm.js"></script>
<script src="buildings/maker_house.js"></script>
<script src="buildings/maker_field.js"></script>
<!--buildings and fields-->
<script src="buildings/forest.js"></script>
<script src="buildings/barn.js"></script>
<script src="buildings/beehive.js"></script>
<script src="buildings/mountain.js"></script>
<script src="buildings/metal.js"></script>
<script src="buildings/villa.js"></script>
<script src="buildings/windmill.js"></script>
<script src="buildings/watermill.js"></script>
<script src="buildings/smithy.js"></script>
<script src="buildings/palace.js"></script>
<!--buildings religious-->
<script src="buildings/church.js"></script>
<script src="buildings/cathedral.js"></script>
<script src="buildings/cloister.js"></script>
<!--buildings and entertainment-->
<script src="buildings/jousting.js"></script>
<script src="buildings/inn.js"></script>
<script src="buildings/marketstall.js"></script>
<!--buildings and houses-->
<script src="buildings/urban.js"></script>
<script src="buildings/business.js"></script>
<!--buildings and fortifications-->
<script src="buildings/castlekeep.js"></script>
<script src="buildings/citywall.js"></script>
<script src="buildings/gatetower.js"></script>
<script src="buildings/castlegate.js"></script>
<!--fields-->
<script src="buildings/field_wheat.js"></script>
<script src="buildings/grapevine.js"></script>
<script src="buildings/olive_tree.js"></script>
<script src="buildings/pomegranate_tree.js"></script>
<script src="buildings/sugarcane.js"></script>
<script src="buildings/flax.js"></script>
<!--props-->
<script src="props/fence.js"></script>
<script src="props/scroll.js"></script>
<script src="props/cabbage.js"></script>
<script src="props/barrel.js"></script>
<script src="props/winebarrel.js"></script>
<script src="props/stool.js"></script>
<script src="props/jug.js"></script>
<!--environment: plane en skybox-->
<script src="environment/villePlane.js"></script>
<script src="environment/plane.js"></script>
<script src="environment/Skybox.js"></script>
<!--lighting-->
<script src="lighting/BarracksLight.js"></script>
<!--animals-->
<script src="animals/chicken.js"></script>
<script src="animals/rooster.js"></script>
<script src="animals/pheasant.js"></script>
<script src="animals/deer.js"></script>
<script src="animals/duck.js"></script>
<script src="animals/donkey.js"></script>
<script src="animals/cow.js"></script>
<script src="animals/goat.js"></script>
<script src="animals/sheep.js"></script>
<script src="animals/horse.js"></script>
<script src="animals/camel.js"></script>
<script src="animals/pig.js"></script>
<!--collision detection-->
<script src="collision/villaCollision.js"></script>
<!--people-->
<script src="people/person.js"></script>
<!--economy-->
<script src="economy/Shooting.js"></script>
<script src="economy/Gathering.js"></script>
<!--styling-->
<link rel="stylesheet" type="text/css" href="Styling.css">
</head>
<body class="ng-scope" style="margin: 0px; background-color: #d8e7ff; overflow: hidden;" onload="loadImperium()">
<div class="parent" id="parent">  
   <!--customcanvas-->       
<div height="400" width="800" class="customcanvas" id="customcanvas"></div>
        <!--hud-->
                <div id="content-frame" ng-controller="HudState" class="ng-scope">
                                <div id="canvas-container">
                                    <div id="canvas-align">
                                        <canvas id="webgl-canvas" width="800" height="400"></canvas>
                                        <div id="hud" ng-class="{visible: style.visible, transparent: style.transparent, perspective: style.perspective, animated: style.animated}" class="visible">
                                            <div id="weapon" class="ng-binding">
                                                
                                            </div>
                                            <div id="ammo" class="ng-binding">
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div>
                        <!--menu-->
                        <div id="menu" class="ng-menu">
                                <div id="content-frame" class="ng-scope">
                                        <div id="canvas-container">
                                                <div id="quit">
                                                        <button id="quitbutton">Quit</button>                                                        
                                                </div>
                                                <div id="resume">
                                                        <button id="resumebutton">Resume</button>
                                                </div>
                                        </div>
                                        
                                </div>
                                        
                        </div>
</div>
<!--loaders-->
<script src="loaders/OBJLoader.js"></script>
<script src="loaders/MTLLoader.js"></script>
<script src="loaders/ModelLoader.js"></script>
<script>

//collision vars
var MovingCube;
var collidableMeshList = [];
var collidableBulletMeshList = [];
//collidable props
var collidablePropMeshList = []; 
var propTypes = [];
//no show menu
var gamestart = document.getElementById("menu");
gamestart.style.display = "none";
//page url for region type
var urlParams = new URLSearchParams(location.search);
var actid = urlParams.get('region');
var urlid = actid - 1;
var province,climate,horse,cattle,sheep,goat,herb,entertainment,deposit;
//var grain,vine,oil,pottery,timber,honey,fruit;
//var tin,copper,iron,gold,silver;
//var paper,seasoning,scent,carving,fabrics,glass;
if (actid >=1 && actid <=260){
        var uprovince = xprov[urlid].getElementsByTagName("place")[0].childNodes[0].nodeValue;
        province = uprovince.replace("_", " ");
        climate = xprov[urlid].getElementsByTagName("climate")[0].childNodes[0].nodeValue;
		culture = xprov[urlid].getElementsByTagName("culture")[0].childNodes[0].nodeValue;
		entertainment = xprov[urlid].getElementsByTagName("style")[0].childNodes[0].nodeValue;
        //reional resources
        horse = xprov[urlid].getElementsByTagName("ride")[0].childNodes[0].nodeValue;
		herb = xprov[urlid].getElementsByTagName("herb")[0].childNodes[0].nodeValue;
		//regional animal types
		cattle = xprov[urlid].getElementsByTagName("cattle")[0].childNodes[0].nodeValue;
        sheep = xprov[urlid].getElementsByTagName("sheep")[0].childNodes[0].nodeValue;
        goat = xprov[urlid].getElementsByTagName("goat")[0].childNodes[0].nodeValue;
		warhorse = xprov[urlid].getElementsByTagName("horse")[0].childNodes[0].nodeValue;
		//settlement resources
		commerceCapital = xprov[urlid].getElementsByTagName("capital")[0].getElementsByTagName("com")[0].childNodes[0].nodeValue;
		factoryCapital = xprov[urlid].getElementsByTagName("capital")[0].getElementsByTagName("factory")[0].childNodes[0].nodeValue;
		armorerCapital = xprov[urlid].getElementsByTagName("capital")[0].getElementsByTagName("arms")[0].childNodes[0].nodeValue;
		commerceCastle = xprov[urlid].getElementsByTagName("castle")[0].getElementsByTagName("com")[0].childNodes[0].nodeValue;
		factoryCastle = xprov[urlid].getElementsByTagName("castle")[0].getElementsByTagName("factory")[0].childNodes[0].nodeValue;
		armorerCastle = xprov[urlid].getElementsByTagName("castle")[0].getElementsByTagName("arms")[0].childNodes[0].nodeValue;
		commerceTown = xprov[urlid].getElementsByTagName("town")[0].getElementsByTagName("com")[0].childNodes[0].nodeValue;
		factoryTown = xprov[urlid].getElementsByTagName("town")[0].getElementsByTagName("factory")[0].childNodes[0].nodeValue;
		armorerTown = xprov[urlid].getElementsByTagName("town")[0].getElementsByTagName("arms")[0].childNodes[0].nodeValue;
		commerceAbbey = xprov[urlid].getElementsByTagName("abbey")[0].getElementsByTagName("com")[0].childNodes[0].nodeValue;
		factoryAbbey = xprov[urlid].getElementsByTagName("abbey")[0].getElementsByTagName("factory")[0].childNodes[0].nodeValue;
		armorerAbbey = xprov[urlid].getElementsByTagName("abbey")[0].getElementsByTagName("arms")[0].childNodes[0].nodeValue;
		//settlement size
		popCapital = xprov[urlid].getElementsByTagName("capital")[0].getElementsByTagName("pop")[0].childNodes[0].nodeValue;
		popCastle = xprov[urlid].getElementsByTagName("castle")[0].getElementsByTagName("pop")[0].childNodes[0].nodeValue;
		popTown = xprov[urlid].getElementsByTagName("town")[0].getElementsByTagName("pop")[0].childNodes[0].nodeValue;
		popAbbey = xprov[urlid].getElementsByTagName("abbey")[0].getElementsByTagName("pop")[0].childNodes[0].nodeValue;
		//fortification
		fortCapital = xprov[urlid].getElementsByTagName("capital")[0].getElementsByTagName("fort")[0].childNodes[0].nodeValue;
		fortCastle = xprov[urlid].getElementsByTagName("castle")[0].getElementsByTagName("fort")[0].childNodes[0].nodeValue;
		fortTown = xprov[urlid].getElementsByTagName("town")[0].getElementsByTagName("fort")[0].childNodes[0].nodeValue;
		fortAbbey = xprov[urlid].getElementsByTagName("abbey")[0].getElementsByTagName("fort")[0].childNodes[0].nodeValue;
		//settlement buildings
        feudalCapital = xprov[urlid].getElementsByTagName("capital")[0].getElementsByTagName("feudal")[0].childNodes[0].nodeValue;
		churchCapital = xprov[urlid].getElementsByTagName("capital")[0].getElementsByTagName("church")[0].childNodes[0].nodeValue;
		civilCapital = xprov[urlid].getElementsByTagName("capital")[0].getElementsByTagName("civil")[0].childNodes[0].nodeValue;
		monasticCapital = xprov[urlid].getElementsByTagName("capital")[0].getElementsByTagName("monastic")[0].childNodes[0].nodeValue;
		educationCapital = xprov[urlid].getElementsByTagName("capital")[0].getElementsByTagName("edu")[0].childNodes[0].nodeValue;
		
		feudalCastle = xprov[urlid].getElementsByTagName("castle")[0].getElementsByTagName("feudal")[0].childNodes[0].nodeValue;
		churchCastle = xprov[urlid].getElementsByTagName("castle")[0].getElementsByTagName("church")[0].childNodes[0].nodeValue;
		civilCastle = xprov[urlid].getElementsByTagName("castle")[0].getElementsByTagName("civil")[0].childNodes[0].nodeValue;
		monasticCastle = xprov[urlid].getElementsByTagName("castle")[0].getElementsByTagName("monastic")[0].childNodes[0].nodeValue;
		educationCastle = xprov[urlid].getElementsByTagName("castle")[0].getElementsByTagName("edu")[0].childNodes[0].nodeValue;
		
		feudalTown = xprov[urlid].getElementsByTagName("town")[0].getElementsByTagName("feudal")[0].childNodes[0].nodeValue;
		churchTown = xprov[urlid].getElementsByTagName("town")[0].getElementsByTagName("church")[0].childNodes[0].nodeValue;
		civilTown = xprov[urlid].getElementsByTagName("town")[0].getElementsByTagName("civil")[0].childNodes[0].nodeValue;
		monasticTown = xprov[urlid].getElementsByTagName("town")[0].getElementsByTagName("monastic")[0].childNodes[0].nodeValue;
		educationTown = xprov[urlid].getElementsByTagName("town")[0].getElementsByTagName("edu")[0].childNodes[0].nodeValue;
		
		feudalAbbey = xprov[urlid].getElementsByTagName("abbey")[0].getElementsByTagName("feudal")[0].childNodes[0].nodeValue;
		churchAbbey = xprov[urlid].getElementsByTagName("abbey")[0].getElementsByTagName("church")[0].childNodes[0].nodeValue;
		civilAbbey = xprov[urlid].getElementsByTagName("abbey")[0].getElementsByTagName("civil")[0].childNodes[0].nodeValue;
		monasticAbbey = xprov[urlid].getElementsByTagName("abbey")[0].getElementsByTagName("monastic")[0].childNodes[0].nodeValue;
		educationAbbey = xprov[urlid].getElementsByTagName("abbey")[0].getElementsByTagName("edu")[0].childNodes[0].nodeValue;
}
else {
        window.location.assign("index.html")
}
// Bullets array
var bullets = [];
var bulletmeshes = [];      
//updater
var updateFcts = [];
//scene
var scene = new THREE.Scene();
//fog
scene.fog = new THREE.FogExp2( 0xd0e0f0, 0.0002 );
//renderer
var renderer = new THREE.WebGLRenderer( { antialias: false } );
//window
canvasWidth = window.innerWidth * 0.98; //screen.width; //800;
canvasHeight = window.innerHeight - 100; //400;
renderer.setSize( canvasWidth, canvasHeight );      
//append object to it
document.getElementById("customcanvas").appendChild(renderer.domElement);
//camera
var camera = new THREE.PerspectiveCamera(45, canvasWidth / canvasHeight, 0.01, 7650);
camera.position.y = 12;
camera.position.z = -67;
camera.position.x = -21;
//environment
var environmentsize = 5100;//4950
//plane
if(climate =="desert" || climate =="desert_marshes"){
	//planes
	var impluve =new PartPlane(environmentsize,environmentsize,"ground7",0,0,0);
	scene.add( impluve );
}
else {
	//planes
	var impluve =new PartPlane(environmentsize,environmentsize,"ground5",0,0,0);
	scene.add( impluve );
}
//skybox
var skyBox = new Skybox(environmentsize,environmentsize,environmentsize);
scene.add( skyBox );
//lighting 
barracksLighter();
//city wall offset
var wallOffset =60;
//fields and buildings and props and people, x5, z5
centerMaker(60,-30);
capitalMaker(60,-1830);
castleMaker(-1290,-30);
townMaker(1410,-30);
abbeyMaker(60,1770);
//moving cube
var cubeGeometry = new THREE.CylinderGeometry(5,5,20,4);
var wireMaterial = new THREE.MeshBasicMaterial( { color: 0xff0000, wireframe:true, visible:false } );
MovingCube = new THREE.Mesh( cubeGeometry, wireMaterial );
MovingCube.position.set(camera.position.x, camera.position.y, camera.position.z);
scene.add( MovingCube );  
//Camera Controls
var controls = new THREE.FirstPersonControls( camera );
controls.lookSpeed = 0.05;
controls.lookVertical = false; //if true vertical look on mousemovement
//Locking the pointer to the game
document.getElementById("parent").addEventListener( 'click', function ( event ) {
        lock();
}, false );
function lock(rawr) {
        document.getElementById("parent").requestPointerLock();
} 
//initial economy variables
var totalItem;
var totalCoin = 12;
var totalBread = 3;
var totalArrow = 23;
var totalSauce = 2;
var totalOil = 2;
var totalWine = 5;
var totalPottery = 1;
var totalCheese = 1;
var eItem ="Purse";
//initial item
totalItem = totalCoin;
//show HUD economy functions
function appendCoin(){        
        document.getElementById('ammo').innerHTML = totalItem;}
function appendItem(){
        document.getElementById('weapon').innerHTML = eItem;}
//hit registration collision
function clearText()
{   document.getElementById('message').innerHTML = '...';}
function appendText(txt)
{   document.getElementById('message').innerHTML += txt;}
//collision vars
var collisionX;
var collisionZ;
//economy HUD
appendCoin();
appendItem();
//onload loop
function GameLoop(){

        //update function
        updateFcts.push(function(delta,now){
                //controls update
                controls.update( delta ); 
                //render the scene
                renderer.render( scene, camera );
                //moving cube position and rotation
                MovingCube.position.x = camera.position.x;
                MovingCube.position.y = camera.position.y;
                MovingCube.position.z = camera.position.z;
                MovingCube.rotation.y = camera.rotation.y;                             
                //bullets
                BulletTravel(delta);
                //ambient
                soundGathering();
        })
        /*
        //loop runner
        var lastTimeMsec= null
        requestAnimationFrame(function animate(nowMsec){
                // keep looping
                requestAnimationFrame( animate );
                // measure time
                lastTimeMsec = lastTimeMsec || nowMsec-1000/60
                var deltaMsec = Math.min(200, nowMsec - lastTimeMsec)
                lastTimeMsec = nowMsec
                // call each update function
                updateFcts.forEach(function(updateFn){
                        updateFn(deltaMsec/1000, nowMsec/1000)
                })
        })
	*/
}
function newDoc() {
    window.location.assign("map.html")
}

</script>
</div>
<div id="game" class="game">
        <!--message-->
        <div id="message" class="ce"></div>
        <!--minimap-->
        <div id="minimap" class="ce">
                <canvas id="myCanvas" width="40" height="40" style="border:1px solid #d3d3d3;">Your browser does not support the HTML5 canvas tag.</canvas>
        </div>
        <!--music-->
        <div id="sound" class="ce">                
                <audio id="imperia" loop><source id="parade" src="music/Rome_4.mp3" type="audio/mp3"></audio>   
                <audio id="soundpar" autoplay><source id="soundscape" src="sfx/atmosphere/birds.mp3" type="audio/mp3"></audio> 
                <button onclick="changeImperium()" type="button">Change Music</button>
                <button onclick="pauseImperium()" type="button">Pause Music</button>
                <button onclick="playImperium()" type="button">Play Music</button>
                <input type="hidden" id="number" value="2"/>
                <!--sound scripts-->
                <script src="sound/musicplayer.js"></script>
                <script src="sound/soundplayer.js"></script>
                <script src="sound/ambient_ville.js"></script>

        </div>
</div>
</body>
</html>